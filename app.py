import streamlit as st
import pandas as pd
import numpy as np
from prophet import Prophet
from prophet.diagnostics import performance_metrics
from prophet.diagnostics import cross_validation
from prophet.plot import plot_cross_validation_metric
from prophet.plot import plot_plotly, plot_components_plotly
from prophet.plot import add_changepoints_to_plot
from prophet.plot import plot_yearly
import base64

with st.sidebar:
        """
         –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ –≤–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫—É –í–∏ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –±—ñ–∑–Ω–µ—Å—É —Ä–æ–∑–¥—Ä—ñ–±–Ω–æ—ó —Ç–æ—Ä–≥—ñ–≤–ª—ñ. –ü—Ä–æ–≥—Ä–∞–º–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞ –Ω–∞ –º–∞–ª–∏–π —Ç–∞ —Å–µ—Ä–µ–¥–Ω—ñ–π –±—ñ–∑–Ω–µ—Å, —è–∫–∏–π —É–∂–µ –º–∞—î –ø–µ–≤–Ω–∏–π –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å–≤–æ—ó –ø—Ä–æ–¥–∞–∂—ñ —ñ —Ö–æ—á–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è. 
         –î–ª—è —Ü—å–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏: 
         1. –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö 
         2. –í–≤–µ—Å—Ç–∏ —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≥–Ω–æ–∑—É 
         3. –û–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è —ñ–∑ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—î—é –¥–∞–Ω–∏—Ö 
         4. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑

        """         
        
st.image('Sales-forecast.jpg')

st.title('–ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–µ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è –¥–ª—è —Ä–æ–∑–¥—Ä—ñ–±–Ω–æ—ó —Ç–æ—Ä–≥—ñ–≤–ª—ñ')

"""
 –¶—è –ø—Ä–æ–≥—Ä–∞–º–∞ –¥–æ–ø–æ–º–æ–∂–µ –í–∞–º —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑, —è–∫–∏–π –ø–æ—Ç—Ä—ñ–±–µ–Ω. 
—Å–∞–º–µ –¥–ª—è –í–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥—É, —Ä–æ–∑—Ö–æ–¥—ñ–≤, –ø—Ä–∏–±—É—Ç–∫—É –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–¥–∞–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É. –î–ª—è —Ç–æ–≥–æ, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —è–∫—ñ—Å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑—ñ–±—Ä–∞—Ç–∏
–Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ –ø—Ä–æ–¥–∞–∂—ñ —É –í–∞—à–æ–º—É –±—ñ–∑–Ω–µ—Å—ñ. –Ü –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ–π—Ç–∏ 4 –∫—Ä–æ–∫–∏ —É —Ü—å–æ–º—É –≤–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –í–∞—à–∏—Ö –¥–∞–Ω–∏—Ö.

"""                     


"""
### –ö—Ä–æ–∫ 1. –Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö
"""
df = st.file_uploader('–Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ —Å–≤—ñ–π –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö —Å—é–¥–∏. –ù–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö - —Ü–µ —Ç–∞–±–ª–∏—Ü—è –∑ –¥–∞–Ω–∏–º–∏ –ø—Ä–æ –ø—Ä–æ–¥–∞–∂—ñ, –≤ —è–∫—ñ–π —Ä—è–¥–æ–∫ - —Ü–µ –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂—É, –∞ —Å—Ç–æ–≤–ø–µ—Ü—å - —Ä—ñ–∑–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏. –°—Ç–æ–≤–ø–µ—Ü—å –∑ –¥–∞—Ç–æ—é –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –Ω–∞–∑–≤–∞—Ç–∏ ds —ñ –æ—Ñ–æ—Ä–º–∏—Ç–∏ —É —Ç–∞–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ: –†–†–†–†-–ú–ú-–î–î (–ü—Ä–∏–∫–ª–∞–¥: 2019-05-20). –Ü –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –ø—Ä–æ–≥—Ä–∞–º–∞ –∑—Ä–æ–∑—É–º—ñ–ª–∞, —â–æ —Å–∞–º–µ –í–∏ —Ö–æ—á–µ—Ç–µ —Å–ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞—Ç–∏, —Ç–æ –ø–æ–∑–Ω–∞—á—Ç–µ —Ü–µ–π —Å—Ç–æ–≤–ø–µ—Ü—å y. –°—Ç–æ–≤–ø–µ—Ü—å y –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–≤–∏–º —ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, —è–∫–µ –º–∏ —Ö–æ—á–µ–º–æ —Å–ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞—Ç–∏. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É - csv. –í–Ω–∏–∑—É –±—É–¥–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—Ä–∏–∫–ª–∞–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è.', type='csv')

st.info(
            f"""
                üëÜ –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª .csv. [–ó—Ä–∞–∑–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è](https://raw.githubusercontent.com/BohdanTarchanin/streamlit-sales-pred-7/master/example_retail_sales.csv?token=GHSAT0AAAAAAB3ZH36Q3IR62ASJEVDUTQOAY4J4M3A)
                """
        )

if df is not None:
    data = pd.read_csv(df)
    data['ds'] = pd.to_datetime(data['ds'],errors='coerce') 
    
    st.write(data)
    
    max_date = data['ds'].max()
    st.write(max_date)
    st.success('üëÜ –¶–µ –∫—ñ–Ω—Ü–µ–≤–∞ –¥–∞—Ç–∞ —É –í–∞—à–æ–º—É –Ω–∞–±–æ—Ä—ñ –¥–∞–Ω–∏—Ö')

"""
### –ö—Ä–æ–∫ 2: –í–≤–µ–¥—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É

"""

periods_input = st.number_input('–ù–∞ —Å–∫—ñ–ª—å–∫–∏ –¥–Ω—ñ–≤ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑? –í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –≤—ñ–¥ 1 –¥–æ 365 —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter',
min_value = 1, max_value = 365)

if df is not None:
    m = Prophet()
    m.fit(data)
   
            
"""
### –ö—Ä–æ–∫ 3: –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑—É

–ù–∞–≤–µ–¥–µ–Ω–∞ –Ω–∏–∂—á–µ —Ç–∞–±–ª–∏—Ü—è –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–±–æ—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ - –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è —Ü—ñ–ª—å–æ–≤–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è —É, –∑—Ä–æ–±–ª–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É –¥–∞–Ω–∏—Ö.
* ds - —Å—Ç–æ–≤–ø–µ—Ü—å –∑ –¥–∞—Ç–∞–º–∏ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è
* yhat - –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
* yhat_lower - —ñ–º–æ–≤—ñ—Ä–Ω–∞ –Ω–∏–∂–Ω—è –º–µ–∂–∞  –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è 
* yhat_upper - —ñ–º–æ–≤—ñ—Ä–Ω–∞ –≤–µ—Ä—Ö–Ω—è –º–µ–∂–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è

"""
if df is not None:
    future = m.make_future_dataframe(periods=periods_input)
    
    forecast = m.predict(future)
    fcst = forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']]

    fcst_filtered =  fcst[fcst['ds'] > max_date]    
    st.write(fcst_filtered)
    
    """
    –ù–∞—Å—É–ø–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–æ—Ä–±—Ä–∞–∂–∞—î –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –¥–∞—Ç–∏ (ds) –≤—ñ–¥ —Ü—ñ–ª—å–æ–≤–æ—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (y) —ñ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª.
    –ß–æ—Ä–Ω—ñ –∫—Ä–∞–ø–∫–∏ - —Ñ–∞–∫—Ç–∏—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –∑ —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É –¥–∞–Ω–∏—Ö, –∞ —Å–∏–Ω—è –ª—ñ–Ω—ñ—è - –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—É.
    """
    fig1 = m.plot(forecast)
    st.write(fig1)
    
    st.info('–ì—Ä–∞—Ñ—ñ–∫ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –¥–∞—Ç–∏ –≤—ñ–¥ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ –ø—Ä–æ–≥–Ω–æ–∑—É')


    """
    –ù–∞—Å—Ç—É–ø–Ω—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å —Ç—Ä–µ–Ω–¥ –¥–ª—è —Ü—ñ–ª—å–æ–≤–æ—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤—ñ–¥–Ω–æ—Å–Ω–æ –¥–∞—Ç–∏ —ñ —Å–µ–∑–æ–Ω–Ω—É –∫–æ—Ä–µ–ª—è—Ü—ñ—é.
    """
    fig2 = m.plot_components(forecast)
    st.write(fig2)
      
    st.info('–ì—Ä–∞—Ñ—ñ–∫–∏ —Ç—Ä–µ–Ω–¥—É —ñ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ—ó –∫–æ—Ä–µ–ª—è—Ü—ñ—ó')

    """    
    –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ö –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –í–∏ –º–æ–∂–µ—Ç–µ:
    * –≤—ñ–∑—É–ª—å–Ω–æ –∑–±—ñ–ª—å—à–∏—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ñ—à–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É
    * –æ–±—Ä–∞—Ç–∏ —ñ–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É (—Ç–∏–∂–¥–µ–Ω—å, –º—ñ—Å—è—Ü—å, —Ä—ñ–∫)
    * –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫ —É –≤–∏–≥–ª—è–¥—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    """
        
    fig3 = plot_plotly(m, forecast)
    st.write(fig3)
    
    st.info('–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –¥–∞—Ç–∏ –≤—ñ–¥ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ –ø—Ä–æ–≥–Ω–æ–∑—É')


    fig4 = plot_components_plotly(m, forecast)
    st.write(fig4)
      
    st.info('–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ —Ç—Ä–µ–Ω–¥—É —ñ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ—ó –∫–æ—Ä–µ–ª—è—Ü—ñ—ó')              


"""
### –ö—Ä–æ–∫ 4: –ó–∞–≤–∞–Ω—Ç–∞–∂—É–π—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –í–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É

–ù–∞—Ç–∏—Å–∫–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑" —ñ –∑–±–µ—Ä—ñ–≥–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏ —Å–æ–±—ñ –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä.
"""
if df is not None:
    csv_exp = fcst_filtered.to_csv(index=False)
    # When no file name is given, pandas returns the CSV as a string, nice.
    b64 = base64.b64encode(csv_exp.encode()).decode()  # some strings <-> bytes conversions necessary here
    #href = f'<a href="data:file/csv;base64,{b64}">Download CSV File</a> (right-click and save as ** &lt;forecast_name&gt;.csv**)'
    #st.markdown(href, unsafe_allow_html=True)
    st.download_button(label="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑", data=csv_exp, file_name='prediction_data.csv', mime='text/csv')


