import streamlit as st
import pandas as pd
import numpy as np
from prophet import Prophet
from prophet.diagnostics import performance_metrics
from prophet.diagnostics import cross_validation
from prophet.plot import plot_cross_validation_metric
from prophet.plot import plot_plotly, plot_components_plotly
from prophet.plot import add_changepoints_to_plot
from prophet.plot import plot_yearly
import base64

with st.sidebar:
        """
         –¶—è –ø—Ä–æ–≥—Ä–∞–º–∞ –¥–æ–ø–æ–º–æ–∂–µ –í–∞–º —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑, —è–∫–∏–π –ø–æ—Ç—Ä—ñ–±–µ–Ω
        —Å–∞–º–µ –¥–ª—è –í–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥—É, —Ä–æ–∑—Ö–æ–¥—ñ–≤, –ø—Ä–∏–±—É—Ç–∫—É –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–¥–∞–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É. –î–ª—è —Ç–æ–≥–æ, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —è–∫—ñ—Å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑—ñ–±—Ä–∞—Ç–∏
        –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ –ø—Ä–æ–¥–∞–∂—ñ —É –í–∞—à–æ–º—É –±—ñ–∑–Ω–µ—Å—ñ. –Ü –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ–π—Ç–∏ –• –∫—Ä–æ–∫—ñ–≤ —É —Ü—å–æ–º—É –≤–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –í–∞—à–∏—Ö –¥–∞–Ω–∏—Ö.

        """  
        st.write("–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ –≤–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫—É –í–∏ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –±—ñ–∑–Ω–µ—Å—É —Ä–æ–∑–¥—Ä—ñ–±–Ω–æ—ó —Ç–æ—Ä–≥—ñ–≤–ª—ñ. –ü—Ä–æ–≥—Ä–∞–º–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞ –Ω–∞ –º–∞–ª–∏–π —Ç–∞ —Å–µ—Ä–µ–¥–Ω—ñ–π –±—ñ–∑–Ω–µ—Å, —è–∫–∏–π —É–∂–µ –º–∞—î –ø–µ–≤–Ω–∏–π –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ —Å–≤–æ—ó –ø—Ä–æ–¥–∞–∂—ñ, –∞–ª–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –π–æ–≥–æ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è. –î–ª—è —Ü—å–æ–≥–æ –∑—Ä–æ–±—ñ—Ç—å –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏: 1. –Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö 2. –í–∏–±–µ—Ä—ñ—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑—É 3. –û–∑–Ω–∞–π–æ–º—Ç–µ—Å—è —ñ–∑ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—î—é –¥–∞–Ω–∏—Ö 4. –ó–∞–≤–∞–Ω—Ç–∞–∂—É–π—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑")
        
st.image('Sales-forecast.jpg')

st.title('–ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–µ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è –¥–ª—è —Ä–æ–∑–¥—Ä—ñ–±–Ω–æ—ó —Ç–æ—Ä–≥—ñ–≤–ª—ñ')

"""
 –¶—è –ø—Ä–æ–≥—Ä–∞–º–∞ –¥–æ–ø–æ–º–æ–∂–µ –í–∞–º —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑, —è–∫–∏–π –ø–æ—Ç—Ä—ñ–±–µ–Ω
—Å–∞–º–µ –¥–ª—è –í–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥—É, —Ä–æ–∑—Ö–æ–¥—ñ–≤, –ø—Ä–∏–±—É—Ç–∫—É –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–¥–∞–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É. –î–ª—è —Ç–æ–≥–æ, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —è–∫—ñ—Å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑—ñ–±—Ä–∞—Ç–∏
–Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ –ø—Ä–æ–¥–∞–∂—ñ —É –í–∞—à–æ–º—É –±—ñ–∑–Ω–µ—Å—ñ. –Ü –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ–π—Ç–∏ –• –∫—Ä–æ–∫—ñ–≤ —É —Ü—å–æ–º—É –≤–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–∫—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –í–∞—à–∏—Ö –¥–∞–Ω–∏—Ö.

"""                     


"""
### –ö—Ä–æ–∫ 1. –Ü–º–ø–æ—Ä—Ç –Ω–∞–±–æ—Ä—É –¥–∞–Ω–∏—Ö
"""
df = st.file_uploader('–Ü–º–ø–æ—Ä—Ç—É–π—Ç–µ —Å–≤—ñ–π –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö —Å—é–¥–∏. –ù–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö - —Ü–µ —Ç–∞–±–ª–∏—Ü—è –∑ –¥–∞–Ω–∏–º–∏ –ø—Ä–æ –ø—Ä–æ–¥–∞–∂—ñ, –≤ —è–∫—ñ–π —Ä—è–¥–æ–∫ - —Ü–µ –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂—É, –∞ —Å—Ç–æ–≤–ø–µ—Ü—å - —Ä—ñ–∑–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏. –°—Ç–æ–≤–ø–µ—Ü—å –∑ –¥–∞—Ç–æ—é –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –Ω–∞–∑–≤–∞—Ç–∏ ds —ñ –æ—Ñ–æ—Ä–º–∏—Ç–∏ —É —Ç–∞–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ: –†–†–†–†-–ú–ú-–î–î (–ü—Ä–∏–∫–ª–∞–¥: 2019-05-20). –Ü –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –ø—Ä–æ–≥—Ä–∞–º–∞ –∑—Ä–æ–∑—É–º—ñ–ª–∞, —â–æ —Å–∞–º–µ –í–∏ —Ö–æ—á–µ—Ç–µ —Å–ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞—Ç–∏, —Ç–æ –ø–æ–∑–Ω–∞—á—Ç–µ —Ü–µ–π —Å—Ç–æ–≤–ø–µ—Ü—å y. –°—Ç–æ–≤–ø–µ—Ü—å y –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–≤–∏–º —ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, —è–∫–µ –º–∏ —Ö–æ—á–µ–º–æ —Å–ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞—Ç–∏. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É - csv. –í–Ω–∏–∑—É –±—É–¥–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—Ä–∏–∫–ª–∞–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è.', type='csv')

st.info(
            f"""
                üëÜ –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª .csv. [–ó—Ä–∞–∑–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è](https://raw.githubusercontent.com/zachrenwick/streamlit_forecasting_app/master/example_data/example_wp_log_peyton_manning.csv)
                """
        )

if df is not None:
    data = pd.read_csv(df)
    data['ds'] = pd.to_datetime(data['ds'],errors='coerce') 
    
    st.write(data)
    
    max_date = data['ds'].max()
    st.write(max_date)

"""
### –ö—Ä–æ–∫ 2: –í–∏–±–µ—Ä—ñ—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑—É

"""

periods_input = st.number_input('–ù–∞ —Å–∫—ñ–ª—å–∫–∏ –¥–Ω–≥—ñ–≤ –≤–∏ –± —Ö–æ—Ç—ñ–ª–∏ —Å–ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞—Ç–∏ –º–∞–π–±—É—Ç–Ω—î? –í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –≤—ñ–¥ 1 –¥–æ 365',
min_value = 1, max_value = 365)

if df is not None:
    m = Prophet()
    m.fit(data)
   
            
"""
### –ö—Ä–æ–∫ 3: –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑—É

–ù–∞–≤–µ–¥–µ–Ω–µ –Ω–∏–∂—á–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–∫–∞–∑—É—î –º–∞–π–±—É—Ç–Ω—ñ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è. ¬´—Ü–µ¬ª —î –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º, –∞ –≤–µ—Ä—Ö–Ω—è —Ç–∞ –Ω–∏–∂–Ω—è –º–µ–∂—ñ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) —Å—Ç–∞–Ω–æ–≤–ª—è—Ç—å 80% –¥–æ–≤—ñ—Ä—á–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª.
"""
if df is not None:
    future = m.make_future_dataframe(periods=periods_input)
    
    forecast = m.predict(future)
    fcst = forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']]

    fcst_filtered =  fcst[fcst['ds'] > max_date]    
    st.write(fcst_filtered)
    
    """
    –ù–∞—Å—Ç—É–ø–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–∫–∞–∑—É—î —Ñ–∞–∫—Ç–∏—á–Ω—ñ (—á–æ—Ä–Ω—ñ –∫—Ä–∞–ø–∫–∏) —ñ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω—ñ (—Å–∏–Ω—è –ª—ñ–Ω—ñ—è) –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —á–∞—Å–æ–º.
    """
    fig1 = m.plot(forecast)
    st.write(fig1)


    """
    –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—ñ–ª—å–∫–∞ –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö –∑–æ–±—Ä–∞–∂–µ–Ω—å –ø–æ–∫–∞–∑—É—é—Ç—å –≤–∏—Å–æ–∫–æ—Ä—ñ–≤–Ω–µ–≤—É —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—é –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å, —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—ó –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è —Ç–∞ —Ä—ñ—á–Ω—ñ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—ó (—è–∫—â–æ –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö –æ—Ö–æ–ø–ª—é—î –∫—ñ–ª—å–∫–∞ —Ä–æ–∫—ñ–≤). –ó–∞—à—Ç—Ä–∏—Ö–æ–≤–∞–Ω–∞ –±–ª–∞–∫–∏—Ç–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º –∑–æ–Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î –≤–µ—Ä—Ö–Ω—ñ–π —ñ –Ω–∏–∂–Ω—ñ–π –¥–æ–≤—ñ—Ä—á—ñ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏.
    """
    fig2 = m.plot_components(forecast)
    st.write(fig2)

    fig3 = plot_plotly(m, forecast)
    st.write(fig3)

    fig4 = plot_components_plotly(m, forecast)
    st.write(fig4)
            


"""
### –ö—Ä–æ–∫ 4: –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –í–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É

–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∏–∂—á–µ –¥–æ–∑–≤–æ–ª—è—î –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–æ–π–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≤–∞—à –∫–æ–º–ø‚Äô—é—Ç–µ—Ä –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.
"""
if df is not None:
    csv_exp = fcst_filtered.to_csv(index=False)
    # When no file name is given, pandas returns the CSV as a string, nice.
    b64 = base64.b64encode(csv_exp.encode()).decode()  # some strings <-> bytes conversions necessary here
    #href = f'<a href="data:file/csv;base64,{b64}">Download CSV File</a> (right-click and save as ** &lt;forecast_name&gt;.csv**)'
    #st.markdown(href, unsafe_allow_html=True)
    st.download_button(label="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑", data=csv_exp, file_name='prediction_data.csv', mime='text/csv')


